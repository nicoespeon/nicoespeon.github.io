<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, minimum-scale=1.0"><meta name="description" content="How to properly rebase your repo, removing what should never have been in there without broking your history."><meta property="og:site_name" content="@nicoespeon's blog" /><meta property="og:url" content="http://www.nicoespeon.com/en/2014/04/clean-git-repo-like-a-boss/" /><meta property="og:type" content="article" /><meta property="og:title" content="Clean your git repo, like a boss | @nicoespeon" /><meta property="og:description" content="How to properly rebase your repo, removing what should never have been in there without broking your history." /><meta property="og:image" content="https://fr.gravatar.com/userimage/27601663/eb6a327f57a4931bfdf6c213af65ed2d.jpg?size=300" /><title>Clean your git repo, like a boss | @nicoespeon</title><link rel="icon" href="/assets/img/icon.png"><link rel="author" href="https://plus.google.com/u/0/108378377887967941980"><!-- DNS prefetch for external resources --><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel="dns-prefetch" href="//platform.twitter.com"><link rel="dns-prefetch" href="//p.twitter.com"><link rel="dns-prefetch" href="//cdn.api.twitter.com"><link rel="dns-prefetch" href="//google-analytics.com"><link rel="stylesheet"href='http://fonts.googleapis.com/css?family=Snippet|Roboto:300,100,700'><link rel="stylesheet" href="/assets/css/nicoespeon.css" media="screen"><link rel="stylesheet" href="/assets/css/nicoespeon-print.css" media="print"><!-- Gitgraph.js --><link rel="stylesheet" href="/assets/css/gitgraph.css" media="all"></head><body><div id="site"><div class="container"><div class="grid"><div class="grid__item seven-tenths portable-one-whole" role="main"><header class="media" role="banner"><!-- Brand logo --><img src="http://www.gravatar.com/avatar/46978c87c5c75cea5d05a61fa8b7d95b" class="media__img img--circle" alt="My avatar" width="80" height="80"/><!-- Main navigation --><nav class="media__body" role="navigation"><ul class="nav nav--main"><li><a href="/index.html">Home</a></li><li><a href="/about.html">About</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/worth-reading.html">Worth Reading</a></li></ul></nav><!-- /navigation --></header><!-- /header --><article role="main"><h1>Clean your git repo, like a boss</h1><div class="media"><div class="media__img"><a href="https://twitter.com/share" class="twitter-share-button" data-text="Clean your git repo, like a boss |" data-via="nicoespeon">Tweeter</a></div><div class="media__body brand-face zeta">(23 April, 2014)</div></div><p class="islet">How to properly rebase your repo, removing what should never have been in there without broking your history.</p><h2 id="the-context">The context</h2><p>The life of a git repo could last and change a lot. Conventions often move with our knowledge and mastering of that stuff.</p><p>And there comes the day where you look at your project and realize that it wasn’t such a good idea to commit those <em>external libraries / compiled outputs / videos and other media / &lt;your error here&gt;</em>.</p><p>I personally did a bunch of mistakes with git:</p><ul><li>one day I realized a bit late that if you commit a lot of audio files in your project, then you’ll make it grow insanely. 5 minutes to perform a simple <code>git clone</code> is waaaaaay toooo looooooong.</li><li>few time ago, I even managed to commit the whole <code>vendor/</code> folder of a project by mistake. It didn’t play well with the nice GitHub stats of the project. That’s a tough job to follow the activity of the team when there is a 20.000 updates peak on the very first week.</li></ul><p>And then you realize that:</p><ul><li>it’s pointless to revert the faulty commit(s), it won’t remove the indexed modifications from the history</li><li>the project may not be young, it’d be sad to rebase and re-write every commits from the last 3 months and loose information such as the author / the date</li><li>and even sometimes you’ll have your faulty files committed with other fixes and killer-features</li></ul><p>Need another use case? Just think about Bernard who committed confidential information in a environment config file which should never have been versioned -have you heard about a guy called Murphy?-.</p><p>Now you can figure out that situation when you open the Internet, searching for the magic git command. Here you go, this is precisely what’s this post about -at least, the magic command I know-.</p><h2 id="magic-happens-here">Magic happens here</h2><p>Let’s say I would like to <strong>remove every MP3 files committed by mistake</strong> from a whole project. Plus, <strong>I don’t want to change the author of each commit, neither the date</strong> - but still I want to remove all trace from those files in the history to reduce the size of my repo.</p><p>To do so, I mystically wave my hand in the air and write the following incantation with the other:</p><div class="highlight"><pre><code class="bash">git filter-branch -f --tree-filter <span class="s2">&quot;rm -rf *.mp3&quot;</span> --prune-empty -- --all
</code></pre></div><p>Which would transform this history:</p><div><!-- This div is a bit nasty but necessary for Jekyll/Markdown to correctly compile the canvas --><canvas id="dirty-repo"></canvas></div><p>Into this clean and shiny one:</p><div><!-- This div is a bit nasty but necessary for Jekyll/Markdown to correctly compile the canvas --><canvas id="clean-repo"></canvas></div><p>Dates and authors are still there, which wouldn’t have been true with a classic rebase. Still, the history <strong>has been rewritten</strong>: SHA1 of commits which have been rewritten are different.</p><h2 id="its-a-kind-of-magic">It’s a kind of magic</h2><p>Let’s see what is this looooong mystical command about.</p><h3 id="git-filter-branch"><code>git filter-branch</code></h3><p>The <code>filter-branch</code> command will rewrite a large number of commit in a scriptable way. In other words, it will rewrite the history regarding the options you give.</p><h3 id="f"><code>-f</code></h3><p>The <code>-f</code> option forces <code>git filter-branch</code> to start even if there is an existing temporary <code>refs/original/</code> directory already. Git will use this directory to perform some backup before going further.</p><p>It’s not mandatory then, but if the backup can’t be created, git will tell you to use it anyway.</p><h3 id="tree-filter-shell-command"><code>--tree-filter "&lt;shell command&gt;"</code></h3><p>This option will check every commit of your tree and execute the given shell command.</p><p>I previously used <code>rm -rf *.mp3</code> to ensure there will not be any MP3 file surviving this operation. In this case, I needed to ensure the command is forced -this is for the <code>-rf</code> part- so the cleaning won’t stop if there is an error because of <em>no-mp3-file-in-this-commit</em> reason.</p><p class="islet"><strong>Note</strong> - In case you don't want to actually delete these files but just remove them from the git history, prefer to perform a <code>--index-filter "git rm -rf --cached --ignored-unmatch *.mp3"</code> instead.</p><h3 id="prune-empty"><code>--prune-empty</code></h3><p>We prune any commit that would eventually be empty after we cleaned the history.</p><h3 id="all"><code>-- --all</code></h3><p>The first <code>--</code> will ensure we don’t consider <code>--all</code> as a parameter for <code>--prune-empty</code>, but as another option. And so git will consider every branches of the history to perform the cleaning here.</p><h2 id="final-words">Final words</h2><p>If you’re many to work on the project, please remember that <strong>rewrite the history is not a genuine action</strong>, whatever the method you use. Then, if you really need to do that kind of manipulation, it will be easier for you colleagues to simply clone the new shiny repo.</p><p>If you fear that your manipulation won’t work as expected, just clone the repo somewhere else before doing your stuff. So you’d be able to get it back in case something is going wrong.</p><p class="islet"><strong>Note</strong> - A good idea is to perform that kind of operations in another branch. If you're satisfied with the result, just reset hard the `master` branch onto this one and you're all set.</p><p>Here you go. I hope that could help you… but that you won’t need to use it too often!</p><div id="disqus_thread" role="complementary"></div></article></div><div class="grid__item three-tenths portable-one-whole"role="complementary"><!-- Lang navigation --><nav role="navigation"><ul class="nav nav--stacked text--center"><li class="current" ><a href="/">English version</a></li><li ><a href="/fr/">Version française</a></li></ul></nav><!-- About --><aside class="text--justify"><p>My name is <span class='brand-face'>Nicolas</span> and I'm a french Unit Production Manager at <a href='http://www.metidia.com'>Metidia</a>.</p><p>I <a href='/archive'>write</a> posts about web development and project management. I got <a href='http://www.linkedin.com/profile/view?id=143126897'>LinkedIn</a>, I <a href='https://github.com/nicoespeon/'>code</a> and I <a href='http://twitter.com/nicoespeon'>tweet</a> too.</p></aside><!-- RSS --><aside><p class="text--center"><a href="http://www.nicoespeon.com/feed.xml"><i class="icon-connection"></i>&nbsp;Stay tuned</a></p></aside><!-- Tweets --><aside class="text--center visuallyhidden--portable"><a class="twitter-timeline" href="https://twitter.com/nicoespeon" data-widget-id="320422386929377280">Tweets de @nicoespeon</a></aside><aside class="visuallyhidden--portable push--top"><h2 class="text--center">Friends</h2><a href="http://iceranking.com">IceRanking.com</a> - (SEO) Cédric Brun, Consultant en Référencement Durable</aside></div></div></div><!-- /container --></div><!-- /main-content --><footer role="contentinfo"><div class="container"><p>&copy; 2016 - <a href="https://twitter.com/nicoespeon">Nicolas (Espeon) Carlo</a><br>The website is built upon <a href='https://github.com/mojombo/jekyll'>Jekyll</a> and <a href='http://inuitcss.com/'>inuit.css</a> from the excellent <a href='https://twitter.com/csswizardry'>@csswizardry</a>. Source code is <a href='https://github.com/nicoespeon/nicoespeon.github.io'>hosted on GitHub</a>.</p></div></footer><!-- jQuery --><script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script>$( function () {/*** This JS code is still small so its better to keep it inline.** Only apply if we are beyond the desk CSS breakpoint on load*/if ( $( window ).width() >= 1024 ) {var $timeline = $( "ul#timeline" );/*** Then hide every label description of the timeline*/$timeline.find( "a.timeline__label" ).each( function () {$( this ).find( "p" ).hide();} );/*** And delegate the visibility effect on hover for each label description*/$timeline.on( "mouseenter mouseleave", "a.timeline__label", function () {$( this ).find( "p" ).stop().toggle( "slow" );} );}/*** Append anchor to page subtitles with IDs (used for blog posts).*/$( "h2[id], h3[id]" ).each( function () {var $title = $( this );var $anchor = $( "<a href='#" + $title.attr( "id" ) + "' class='anchor'><i class='icon-link'></i></a>" );$title.append( $anchor );} );} );</script><!-- Twitter API --><script>!function ( d, s, id ) {var js, fjs = d.getElementsByTagName( s )[0];if ( !d.getElementById( id ) ) {js = d.createElement( s );js.id = id;js.src = "//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore( js, fjs );}}( document, "script", "twitter-wjs" );</script><!-- Google Analytics --><script>var _gaq = _gaq || [];_gaq.push( ['_setAccount', 'UA-39957541-2'] );_gaq.push( ['_setDomainName', 'nicoespeon.com'] );_gaq.push( ['_trackPageview'] );(function () {var ga = document.createElement( 'script' );ga.type = 'text/javascript';ga.async = true;ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';var s = document.getElementsByTagName( 'script' )[0];s.parentNode.insertBefore( ga, s );})();</script><!-- Disqus --><script>var disqus_shortname = 'nicoespeon';var disqus_url = 'http://nicoespeon.com/en/2014/04/clean-git-repo-like-a-boss/';var title = "Clean your git repo, like a boss";(function () {var dsq = document.createElement( 'script' );dsq.type = 'text/javascript';dsq.async = true;dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';(document.getElementsByTagName( 'head' )[0] || document.getElementsByTagName( 'body' )[0]).appendChild( dsq );})();</script><noscript>Please enable JavaScript to view the <ahref="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><!-- Gitgraph.js --><script src="/assets/scripts/gitgraph.min.js"></script><script src="/assets/scripts/2014-04-23-git-like-a-boss.js"></script></body></html>