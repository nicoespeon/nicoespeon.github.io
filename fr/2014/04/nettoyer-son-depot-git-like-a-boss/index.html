<!DOCTYPE html><html lang="fr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, minimum-scale=1.0"><meta name="description" content="Ou comment rebase proprement son dépôt pour retirer ce qui n'aurait jamais du y être commit, tout en conservant l'historique (si si, c'est possible)."><meta property="og:site_name" content="@nicoespeon's blog" /><meta property="og:url" content="http://www.nicoespeon.com/fr/2014/04/nettoyer-son-depot-git-like-a-boss/" /><meta property="og:type" content="article" /><meta property="og:title" content="Nettoyer son dépôt git, like a boss | @nicoespeon" /><meta property="og:description" content="Ou comment rebase proprement son dépôt pour retirer ce qui n'aurait jamais du y être commit, tout en conservant l'historique (si si, c'est possible)." /><meta property="og:image" content="https://fr.gravatar.com/userimage/27601663/eb6a327f57a4931bfdf6c213af65ed2d.jpg?size=300" /><title>Nettoyer son dépôt git, like a boss | @nicoespeon</title><link rel="icon" href="/assets/img/icon.png"><link rel="author" href="https://plus.google.com/u/0/108378377887967941980"><!-- DNS prefetch for external resources --><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel="dns-prefetch" href="//platform.twitter.com"><link rel="dns-prefetch" href="//p.twitter.com"><link rel="dns-prefetch" href="//cdn.api.twitter.com"><link rel="dns-prefetch" href="//google-analytics.com"><link rel="stylesheet"href='http://fonts.googleapis.com/css?family=Snippet|Roboto:300,100,700'><link rel="stylesheet" href="/assets/css/nicoespeon.css" media="screen"><link rel="stylesheet" href="/assets/css/nicoespeon-print.css" media="print"><!-- Gitgraph.js --><link rel="stylesheet" href="/assets/css/gitgraph.css" media="all"></head><body><div id="site"><div class="container"><div class="grid"><div class="grid__item seven-tenths portable-one-whole" role="main"><header class="media" role="banner"><!-- Brand logo --><img src="http://www.gravatar.com/avatar/46978c87c5c75cea5d05a61fa8b7d95b" class="media__img img--circle" alt="My avatar" width="80" height="80"/><!-- Main navigation --><nav class="media__body" role="navigation"><ul class="nav nav--main"><li><a href="/fr/index.html">Accueil</a></li><li><a href="/fr/about.html">À propos</a></li><li><a href="/fr/projects.html">Projets</a></li><li><a href="/fr/worth-reading.html">A Lire</a></li></ul></nav><!-- /navigation --></header><!-- /header --><article role="main"><h1>Nettoyer son dépôt git, like a boss</h1><div class="media"><a href="https://twitter.com/share" class="twitter-share-button media__img--rev" data-text="Nettoyer son dépôt git, like a boss |" data-via="nicoespeon">Tweeter</a><div class="media__body brand-face zeta">(23 Avril, 2014)</div></div><p class="islet">Ou comment rebase proprement son dépôt pour retirer ce qui n'aurait jamais du y être commit, tout en conservant l'historique (si si, c'est possible).</p><h2 id="le-contexte">Le contexte</h2><p>Un dépôt git, à l’image du projet qu’il contient, peut avoir une vie longue et tumultueuse au cours de laquelle les conventions évoluent avec nos connaissances et notre maîtrise du schmilblick.</p><p>Aussi, il se peut que ce jour arrive où vous contempliez votre projet et réalisiez qu’en fait non, ce n’était pas une si bonne idée que de versionner ces <em>librairies externes / fichiers compilés / vidéos et autres assets / &lt;votre boulette ici&gt;</em>.</p><p>Pour ma part, j’ai pas mal enchaîné les boulettes avec le temps :</p><ul><li>une fois, j’ai réalisé un peu tard que versionner un paquet de fichiers audio dans un projet l’alourdissait de manière indécente. 5 minutes pour faire un <code>git clone</code>, c’est un peu <em>ouate-ze-foque</em>.</li><li>il n’y a pas si longtemps encore, j’ai même réussit à versionner l’ensemble du dossier <code>vendor/</code> d’un projet s’en m’en rendre compte. Et vlan les jolies stats GitHub du projet ; difficile de suivre son activité quand on a un pic de 20.000 modifications la première semaine.</li></ul><p>Or c’est dans ce genre de cas qu’on réalise que :</p><ul><li>il est inutile de revert le(s) commit(s) fautif(s), ça ne supprimera pas les modifications indexées dans l’historique</li><li>le projet n’est plus tout jeune, ça nous ferait mal de rebase les commits des 3 derniers mois et perdre l’auteur / la date de ceux-ci en les ré-écrivant</li><li>et même que parfois on a commit ses fichiers fautifs par-ci par-là au milieu d’autres modifications d’un beau commit</li></ul><p>Un dernier cas de figure ? Suffit d’imaginer Bernard qui, s’en trop le vouloir, a commit par erreur des informations un peu confidentielles dans un fichier de conf d’environnement qui n’aurait jamais du être versionné (sisi, ça arrive).</p><p>Bref, c’est dans ce genre de situation qu’on se résigne ou que l’on retourne l’Internet en quête de la commande git magique. Et ça tombe plutôt bien, parce-que c’est celle-là même que je vais vous proposer (enfin celle que je connais).</p><h2 id="magic-happens-here">Magic happens here</h2><p>Admettons par exemple que je souhaite <strong>supprimer tous les MP3s versionnés par erreur</strong> dans l’ensemble de mon projet.Et ce, <strong>sans changer les auteurs des commits</strong>, <strong>ni même les dates</strong>, mais en supprimant tout de même toute trace de ces fichiers (histoire de réduire considérablement la taille de mon dépôt, par exemple).</p><p>Et donc pour cela, j’ouvre mon terminal et je lance l’incantation suivante :</p><div class="highlight"><pre><code class="bash">git filter-branch -f --tree-filter <span class="s2">&quot;rm -rf *.mp3&quot;</span> --prune-empty -- --all
</code></pre></div><p>Ce qui me permet donc, en partant de ce genre d’historique :</p><div><!-- This div is a bit nasty but necessary for Jekyll/Markdown to correctly compile the canvas --><canvas id="dirty-repo"></canvas></div><p>De me retrouver avec un dépôt propre comme un sous neuf :</p><div><!-- This div is a bit nasty but necessary for Jekyll/Markdown to correctly compile the canvas --><canvas id="clean-repo"></canvas></div><p>Les dates de commit sont conservées, les auteurs aussi, ce qui ne serait pas le cas avec un rebase classique. Toutefois, l’historique est <strong>bel et bien ré-écrit</strong> : les SHA1 des commits qui ont été modifiés sont différents.</p><h2 id="cest-sorcellerie-">C’est sorcellerie !?</h2><p>Voyons un peu ce que ce que cache cette loooongue commande magico-magique.</p><h3 id="git-filter-branch"><code>git filter-branch</code></h3><p>La commande <code>filter-branch</code> de git permet de ré-écrire un grand nombre de commits de manière scriptable. Autrementdit, c’est ce qui va permettre de ré-écrire complètement l’historique en fonction des paramètres que nous allonspasser ensuite.</p><h3 id="f"><code>-f</code></h3><p>L’option <code>-f</code> permet de forcer le démarrage de <code>git filter-branch</code> si jamais il y a déjà un dossier temporaire <code>refs/original/</code> pré-existant. Git s’en sert pour faire une sauvegarde de l’historique avant de partir à l’aventure.</p><p>Le <code>-f</code> n’est donc pas obligatoire mais si le backup ne peut pas être créé, git vous dira de relancer la commande avec cette option.</p><h3 id="tree-filter-shell-command"><code>--tree-filter "&lt;shell command&gt;"</code></h3><p>Cette option va vous permettre de passer en revue chacun de vos commits et d’y exécuter la commande que vous aurez passé en paramètre.</p><p>Pour ma part, j’ai utilisé <code>rm -rf *.mp3</code> pour m’assurer de bien supprimer l’ensemble des fichiers MP3s qui pouvaient être versionnés. Dans un tel cas, il faut s’assurer de forcer la commande (d’où le <code>-rf</code>) car le nettoyage s’arrête s’il y a une erreur à base de <em>fichier-mp3-non-trouvé-dans-ce-commit</em>.</p><p class="islet"><strong>Note</strong> - Au cas où vous ne voudriez pas vraiment supprimer les fichiers mais juste les retirer de l'historique git, préférez l'utilisation de la commande <code>--index-filter "git rm -rf --cached --ignored-unmatch *.mp3"</code> à la place.</p><h3 id="prune-empty"><code>--prune-empty</code></h3><p>On s’assure de bien supprimer les commits qui seraient éventuellement vides, une fois l’historique nettoyé.</p><h3 id="all"><code>-- --all</code></h3><p>Le premier <code>--</code> permet de distinguer <code>--all</code> comme une options supplémentaire, et non pas un paramètre de <code>--prune-empty</code>. Et donc cela permet de dire à git de réaliser son opération sur toutes les branches de l’historique.</p><h2 id="le-mot-de-la-fin">Le mot de la fin</h2><p>Si vous travaillez à plusieurs sur le projet, n’oubliez pas que <strong>ré-écrire l’historique, c’est pas anodin</strong> (et ce,peu importe la méthode). Du coup, si vous êtes amené à faire ce genre de manipulation pour le bien du dépôt,le plus simple reste pour les autres de re-cloner le nouveau dépôt tout propre, tout simplement.</p><p>Et si vous craigniez que votre manipulation ne fonctionne pas comme prévu, clonez simplement le dépôt quelque part avant de faire votre tambouille et vous pourrez toujours le récupérer si jamais ça ne se passe pas bien.</p><p class="islet"><strong>Note</strong> - Une bonne idée serait de faire ce genre d'opérations dans un branche à part. Si le résultat est convaincant, alors il n'y aura plus qu'à faire un reset hard de `master` sur cette branche.</p><p>Voilà, en espérant que ça puisse vous dépanner… mais que vous n’ayez pas à vous en servir trop souvent !</p><div id="disqus_thread" role="complementary"></div></article></div><div class="grid__item three-tenths portable-one-whole"role="complementary"><!-- Lang navigation --><nav role="navigation"><ul class="nav nav--stacked text--center"><li ><a href="/">English version</a></li><li class="current" ><a href="/fr/">Version française</a></li></ul></nav><!-- About --><aside class="text--justify"><p>Je m'appelle <span class='brand-face'>Nicolas</span> et je suis Directeur de Production chez <a href='http://www.metidia.com'>Metidia</a>.</p><p>Je <a href='/archive'>rédige</a> des articles sur le développement web et la gestion de projets. Je suis <a href='http://www.linkedin.com/profile/view?id=143126897'>LinkedIn</a>, je <a href='https://github.com/nicoespeon/'>code</a> et je <a href='http://twitter.com/nicoespeon'>tweet</a> pas mal aussi.</p></aside><!-- RSS --><aside><p class="text--center"><a href="http://www.nicoespeon.com/feed.xml"><i class="icon-connection"></i>&nbsp;Restez connectés</a></p></aside><!-- Tweets --><aside class="text--center visuallyhidden--portable"><a class="twitter-timeline" href="https://twitter.com/nicoespeon" data-widget-id="320422386929377280">Tweets de @nicoespeon</a></aside><aside class="visuallyhidden--portable push--top"><h2 class="text--center">Copains</h2><a href="http://iceranking.com">IceRanking.com</a> - (SEO) Cédric Brun, Consultant en Référencement Durable</aside></div></div></div><!-- /container --></div><!-- /main-content --><footer role="contentinfo"><div class="container"><p>&copy; 2015 - <a href="https://twitter.com/nicoespeon">Nicolas (Espeon) Carlo</a><br>Ce site est construit grâce à <a href='https://github.com/mojombo/jekyll'>Jekyll</a> et à <a href='http://inuitcss.com/'>inuit.css</a> de l'excellent <a href='https://twitter.com/csswizardry'>@csswizardry</a>. Le code source est <a href='https://github.com/nicoespeon/nicoespeon.github.io'>hébergé sur GitHub</a>.</p></div></footer><!-- jQuery --><script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script>$( function () {/*** This JS code is still small so its better to keep it inline.** Only apply if we are beyond the desk CSS breakpoint on load*/if ( $( window ).width() >= 1024 ) {var $timeline = $( "ul#timeline" );/*** Then hide every label description of the timeline*/$timeline.find( "a.timeline__label" ).each( function () {$( this ).find( "p" ).hide();} );/*** And delegate the visibility effect on hover for each label description*/$timeline.on( "mouseenter mouseleave", "a.timeline__label", function () {$( this ).find( "p" ).stop().toggle( "slow" );} );}/*** Append anchor to page subtitles with IDs (used for blog posts).*/$( "h2[id], h3[id]" ).each( function () {var $title = $( this );var $anchor = $( "<a href='#" + $title.attr( "id" ) + "' class='anchor'><i class='icon-link'></i></a>" );$title.append( $anchor );} );} );</script><!-- Twitter API --><script>!function ( d, s, id ) {var js, fjs = d.getElementsByTagName( s )[0];if ( !d.getElementById( id ) ) {js = d.createElement( s );js.id = id;js.src = "//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore( js, fjs );}}( document, "script", "twitter-wjs" );</script><!-- Google Analytics --><script>var _gaq = _gaq || [];_gaq.push( ['_setAccount', 'UA-39957541-2'] );_gaq.push( ['_setDomainName', 'nicoespeon.com'] );_gaq.push( ['_trackPageview'] );(function () {var ga = document.createElement( 'script' );ga.type = 'text/javascript';ga.async = true;ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';var s = document.getElementsByTagName( 'script' )[0];s.parentNode.insertBefore( ga, s );})();</script><!-- Disqus --><script>var disqus_shortname = 'nicoespeon';var disqus_url = 'http://nicoespeon.com/fr/2014/04/nettoyer-son-depot-git-like-a-boss/';var title = "Nettoyer son dépôt git, like a boss";(function () {var dsq = document.createElement( 'script' );dsq.type = 'text/javascript';dsq.async = true;dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';(document.getElementsByTagName( 'head' )[0] || document.getElementsByTagName( 'body' )[0]).appendChild( dsq );})();</script><noscript>Please enable JavaScript to view the <ahref="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><!-- Gitgraph.js --><script src="/assets/scripts/gitgraph.min.js"></script><script src="/assets/scripts/2014-04-23-git-like-a-boss.js"></script></body></html>