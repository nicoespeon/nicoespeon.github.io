{"data":{"site":{"siteMetadata":{"title":"@nicoespeon's blog","subtitles":{"en":"I write about web development, agile practices and personal organization.","fr":"J’écris sur le développement web, les pratiques agiles et l’organisation personnelle."},"author":{"name":"Nicolas Carlo","twitter":"nicoespeon"},"disqusShortname":"nicoespeon","url":"https://www.nicoespeon.com"}},"markdownRemark":{"id":"415dc5c9-1984-5e6f-8985-b908a16fe16f","html":"<p>In this post, I’ll talk about a concrete use case in which Observables turn to be remarkably relevant to make our code cleaner and more maintainable.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cover-5935b0fcde9d2ceaf5b559d1d7811bb0-168cd.jpeg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.64999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwT/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABxwZFIg//xAAaEAADAAMBAAAAAAAAAAAAAAAAAQIDBBMU/9oACAEBAAEFAr1qOWSmsNNPauj02dqP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAHBAAAQMFAAAAAAAAAAAAAAAAAQACECIxQVFh/9oACAEBAAY/AhtMaRwRhNtTH//EABoQAAIDAQEAAAAAAAAAAAAAAAERACFxMfD/2gAIAQEAAT8hDwubEHtjw1DTQZF8GzFS40LLn//aAAwDAQACAAMAAAAQzP8A/8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQMBAT8Qh//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAECAQE/EKf/xAAcEAEBAAMAAwEAAAAAAAAAAAABEQAhQTFhgdH/2gAIAQEAAT8QlqNED26MHC3uNAQcXgKxJZl0fRof3LWyJVwCO/WTfynXfuf/2Q=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"cover\"\n        title=\"\"\n        src=\"/static/cover-5935b0fcde9d2ceaf5b559d1d7811bb0-d564d.jpeg\"\n        srcset=\"/static/cover-5935b0fcde9d2ceaf5b559d1d7811bb0-865fd.jpeg 240w,\n/static/cover-5935b0fcde9d2ceaf5b559d1d7811bb0-d40a0.jpeg 480w,\n/static/cover-5935b0fcde9d2ceaf5b559d1d7811bb0-d564d.jpeg 960w,\n/static/cover-5935b0fcde9d2ceaf5b559d1d7811bb0-c67c1.jpeg 1440w,\n/static/cover-5935b0fcde9d2ceaf5b559d1d7811bb0-667be.jpeg 1920w,\n/static/cover-5935b0fcde9d2ceaf5b559d1d7811bb0-168cd.jpeg 2000w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2 id=\"how-to-spot-a-barcode-scanner\"><a href=\"#how-to-spot-a-barcode-scanner\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to spot a barcode scanner?!</h2>\n<p>Yup! This is kind of a specific example. But it perfectly illustrates issues that would beg you for using Observables.</p>\n<p>A barcode scanner simply emulates the keyboard. It reproduces the scanned code, emitting keypress signals, ending with the “Enter” key − which key code is <em>13</em>.</p>\n<p>Let’s say we’re developing an app that allows users to search products from their 16-chars code reference. Rather than typing them by hand, users should be able to use a barcode scanner to trigger the search.</p>\n<blockquote>\n<p>“Just let the user focus the search input, scan and you’re done!”</p>\n</blockquote>\n<p>Sure, it’s native behavior.</p>\n<p>But the search feature is contained inside a popup that can be open with a button. And we’ve been told the app should be super-ergonomic! Whenever the user scans a barcode, we should open the popup and fill the input with the scanned code.</p>\n<p>Now, the problem is: how do we differentiate a scanned code from other keypress events? Let’s say the user hit a key before scanning the code: we don’t want that key to be part of the scanned code!</p>\n<h2 id=\"solving-this-the-imperative-way\"><a href=\"#solving-this-the-imperative-way\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solving this, the imperative way</h2>\n<p>We surely need to listen to keypress events… Then we must… remember the key codes, probably using a buffer! If the key pressed is the “Enter” key, fill the input and clean the buffer. Otherwise, add the key to the buffer!</p>\n<p>Let’s try this first shot:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">ENTER_KEY_CODE</span> <span class=\"token operator\">=</span> <span class=\"token number\">13</span>\n<span class=\"token keyword\">let</span> keyCodesBuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\ndocument<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'keypress'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> keyCode <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>keyCode\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>keyCode <span class=\"token operator\">===</span> <span class=\"token constant\">ENTER_KEY_CODE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">fillInputWithKeyCodesBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">cleanBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">addToBuffer</span><span class=\"token punctuation\">(</span>keyCode<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">fillInputWithKeyCodesBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// …</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">cleanBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  keyCodesBuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">addToBuffer</span><span class=\"token punctuation\">(</span>keyCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  keyCodesBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>keyCode<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Good.</p>\n<p>But this is not enough: it doesn’t differentiate scanned codes from regular keypresses!</p>\n<p>We know that, if no new keypress is emitted after ~50ms, it’s not a scanned code for sure and we can clean the buffer.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">ENTER_KEY_CODE</span> <span class=\"token operator\">=</span> <span class=\"token number\">13</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_INTERVAL_BETWEEN_EVENTS_IN_MS</span> <span class=\"token operator\">=</span> <span class=\"token number\">50</span>\n<span class=\"token keyword\">let</span> keyCodesBuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\ndocument<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'keypress'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> keyCode <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>keyCode\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>keyCode <span class=\"token operator\">===</span> <span class=\"token constant\">ENTER_KEY_CODE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">fillInputWithKeyCodesBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">cleanBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">addToBuffer</span><span class=\"token punctuation\">(</span>keyCode<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">cleanBufferAfter</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MAX_INTERVAL_BETWEEN_EVENTS_IN_MS</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">fillInputWithKeyCodesBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// …</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">cleanBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  keyCodesBuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">addToBuffer</span><span class=\"token punctuation\">(</span>keyCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  keyCodesBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>keyCode<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">cleanBufferAfter</span><span class=\"token punctuation\">(</span>timeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>cleanBuffer<span class=\"token punctuation\">,</span> timeout<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Hmmm… not bad. But there is a subtle bug here: if the code takes more than 50ms to be scanned, it will drop the beginning…</p>\n<p>In fact, if a new keypress occurs within 50ms, we should clear the timeout.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">ENTER_KEY_CODE</span> <span class=\"token operator\">=</span> <span class=\"token number\">13</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_INTERVAL_BETWEEN_EVENTS_IN_MS</span> <span class=\"token operator\">=</span> <span class=\"token number\">50</span>\n<span class=\"token keyword\">let</span> keyCodesBuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">let</span> cleanBufferTimeout\n\ndocument<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'keypress'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> keyCode <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>keyCode\n\n  <span class=\"token function\">stopCleanBufferTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>keyCode <span class=\"token operator\">===</span> <span class=\"token constant\">ENTER_KEY_CODE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">fillInputWithKeyCodesBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">cleanBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">addToBuffer</span><span class=\"token punctuation\">(</span>keyCode<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">cleanBufferAfter</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MAX_INTERVAL_BETWEEN_EVENTS_IN_MS</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">fillInputWithKeyCodesBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// …</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">cleanBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  keyCodesBuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">addToBuffer</span><span class=\"token punctuation\">(</span>keyCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  keyCodesBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>keyCode<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">cleanBufferAfter</span><span class=\"token punctuation\">(</span>timeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  cleanBufferTimeout <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>cleanBuffer<span class=\"token punctuation\">,</span> timeout<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">stopCleanBufferTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>cleanBufferTimeout<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we’ve got something working.</p>\n<p>Let’s take a step back and think: what if we’ve had the full history of keypress events we could manipulate to filter out scanned codes sequences? Would the code be simpler? Let’s figure this out…</p>\n<h2 id=\"solving-this-with-observables\"><a href=\"#solving-this-with-observables\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Solving this, with Observables</h2>\n<p>For this kind of use cases, I find Observables to be a powerful abstraction to represent our data.</p>\n<blockquote>\n<p>Observables are <strong>immutable collections of asynchronous events</strong> you can manipulate through <strong>operators</strong>.</p>\n</blockquote>\n<p>If we use things like <code class=\"language-text\">map</code> and <code class=\"language-text\">filter</code> over arrays, then we’re already familiar with that way of thinking.</p>\n<blockquote>\n<p>If Observables are still cryptic for you so far, I’d suggest you to read <a href=\"https://gist.github.com/staltz/868e7e9bc2a7b8c1f754\">this excellent introduction to Reactive Programming</a> from André Staltz.</p>\n</blockquote>\n<p>So, instead of responding to each event individually, let’s collect all events into a single stream that we can transform.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> keyCode$ <span class=\"token operator\">=</span> Rx<span class=\"token punctuation\">.</span>Observable<span class=\"token punctuation\">.</span><span class=\"token function\">fromEvent</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">,</span> <span class=\"token string\">'keypress'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// ---(ev)--(ev)--------(ev)---></span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">pluck</span><span class=\"token punctuation\">(</span><span class=\"token string\">'keyCode'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// ---(43)--(51)--------(13)---></span></code></pre></div>\n<p>The <strong>$</strong> sign at the end of the variable name means “Stream”. It’s a convention I use to know the variable I manipulate is an Observable in non-typed languages, just like I’d call <strong>elements</strong> an array of <strong>element</strong>, or <strong>$header</strong> the jQuery representation of the header.</p>\n<p>Now we have a stream of key codes. Any time a keypress event occurs, a new event, which value is the corresponding key code, is emitted.</p>\n<p>At the end of the process, we’d like to have a stream we can subscribe to. Each event of the stream should represent the scanned code. So we need to make batches of key codes in a way that isolates scanned codes from parasitic keypresses.</p>\n<p>To do so, we can <strong>buffer</strong> our stream using a <strong>debounce</strong> strategy: when an event occurs, wait 50ms for another one. If another event is emitted within this time frame, wait another 50ms. If no other event occurs within this time frame, make a batch of the passed events.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/buffer-operator-411ffd63484f377c930a01383efc1f68-b5a16.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 61.71875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAC50lEQVQoz2OIjY1VnDdv3vaO7u4KBgYGHiAWg2LenqbutIULF+5zNDMzAvL5oeLiQCzYN6WvZf68+Wvl5OVUgXxNRkZGRyAtyQADNYEhcueLS8z37+zUOXU4Sb//+CwdiyX2eiC5iadPGYYcO6g9reuIkWfsPrXbC8/p9BtO0oHp5efjZwVSTGCOgZiICJCSXuVpM2ONmvKTVauN9m5bJn9UabnJfsW1aidArjLdvfuc+PL5O62sNp3n1Ju14qDfun2r7dYdBsrJSfNKKwJdZwXEkUCsBDY0/f9/RgOgoWoMDFralgxy+ooMKgw6DPIMCgwaYAVaWhoMmoqyQAZQiYKUFYO+ohKDsprtO0dGkLSysjKHlZUVKwMSMAVioGIGUHgIAzHIJlEgBoWdHpQvApUXgoajJRDrQ/WbQ/UxMOzatSvrBhDcvn376I0b10/fu3fv6K1bt05dv3H9+JEjR86eOHHi5NmzZ0+dO3/+GBCcvnLlytFbN28dv37t+lmgtlMvXrzYe/369ZN37969tH379nSGo0ePLviPA9y5cweMX758+f/Jkyf/gQb8f/PmDS7l/4EOmMXQ3NzsAkwazUBcCcTVQFy1CEivWLKkdMWK5ZXz5s1qXrFyRenKtSvL16xdU7Ns5cqKhYsXl8ycObt64sTJDcuXLCtdumRp+YIFC5obGhqcGPADZi4GBkYzbDLA2BDi5GYwhnJl4RKSkpJ80tLSCkAsq6epoQAUEljS1lx0u6X+/7VTm77duVH37ejdfb8TTmU8zs6N8Gq6eOXatBvX//X33vi6cOGFXy8m3/+c4JzUAtRnpyijCE7YHNAYEpQWFADFJOvEmJD0neGB7/fvnPhk//bgp3OOznllvMLiamFslKPHlq3Hq3fufhOdvPtpX8eOZwdTdz5P8U6PBerTEOQRFMft285p/MaODUALZgpnaxeKnGXYyQkS7mBgYJ+uoy7a28Ig1NhlIcKQwMCHrA0AbQFZmgEy2uYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"buffer operator\"\n        title=\"\"\n        src=\"/static/buffer-operator-411ffd63484f377c930a01383efc1f68-c83f1.png\"\n        srcset=\"/static/buffer-operator-411ffd63484f377c930a01383efc1f68-569e3.png 240w,\n/static/buffer-operator-411ffd63484f377c930a01383efc1f68-93400.png 480w,\n/static/buffer-operator-411ffd63484f377c930a01383efc1f68-c83f1.png 960w,\n/static/buffer-operator-411ffd63484f377c930a01383efc1f68-b5a16.png 1280w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>This is what we want to achieve with <a href=\"http://reactivex.io/documentation/operators/buffer.html\">the buffer operator</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_INTERVAL_BETWEEN_EVENTS_IN_MS</span> <span class=\"token operator\">=</span> <span class=\"token number\">50</span>\n\n<span class=\"token keyword\">const</span> keyCode$ <span class=\"token operator\">=</span> Rx<span class=\"token punctuation\">.</span>Observable<span class=\"token punctuation\">.</span><span class=\"token function\">fromEvent</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">,</span> <span class=\"token string\">'keypress'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pluck</span><span class=\"token punctuation\">(</span><span class=\"token string\">'keyCode'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> keyCodesBuffer$ <span class=\"token operator\">=</span> keyCode$\n  <span class=\"token comment\">// --(43)-(64)----(32)-----(65)-(77)-(13)---></span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">buffer</span><span class=\"token punctuation\">(</span>keyCode$<span class=\"token punctuation\">.</span><span class=\"token function\">debounce</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MAX_INTERVAL_BETWEEN_EVENTS_IN_MS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// --([43,64])----([32])-----([65,77,13])---></span></code></pre></div>\n<p>So far, so good!</p>\n<p>Now, all we have to do is to filter out batches that don’t look like scanned codes. And we know that a scanned code is a sequence that ends with the “Enter” key.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">ENTER_KEY_CODE</span> <span class=\"token operator\">=</span> <span class=\"token number\">13</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_INTERVAL_BETWEEN_EVENTS_IN_MS</span> <span class=\"token operator\">=</span> <span class=\"token number\">50</span>\n\n<span class=\"token keyword\">const</span> keyCode$ <span class=\"token operator\">=</span> Rx<span class=\"token punctuation\">.</span>Observable<span class=\"token punctuation\">.</span><span class=\"token function\">fromEvent</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">,</span> <span class=\"token string\">'keypress'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pluck</span><span class=\"token punctuation\">(</span><span class=\"token string\">'keyCode'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> keyCodesBuffer$ <span class=\"token operator\">=</span> keyCode$\n  <span class=\"token punctuation\">.</span><span class=\"token function\">buffer</span><span class=\"token punctuation\">(</span>keyCode$<span class=\"token punctuation\">.</span><span class=\"token function\">debounce</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MAX_INTERVAL_BETWEEN_EVENTS_IN_MS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isFromScan<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isFromScan</span><span class=\"token punctuation\">(</span>keyCodes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> keyCodes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> keyCodes<span class=\"token punctuation\">[</span>keyCodes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token constant\">ENTER_KEY_CODE</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Finally, let’s subscribe to this stream we have created and execute our callback each time a new event is emitted.</p>\n<blockquote>\n<p>Nothing will happen until we subscribe to the Observable, since they are lazy.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">ENTER_KEY_CODE</span> <span class=\"token operator\">=</span> <span class=\"token number\">13</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_INTERVAL_BETWEEN_EVENTS_IN_MS</span> <span class=\"token operator\">=</span> <span class=\"token number\">50</span>\n\n<span class=\"token keyword\">const</span> keyCode$ <span class=\"token operator\">=</span> Rx<span class=\"token punctuation\">.</span>Observable<span class=\"token punctuation\">.</span><span class=\"token function\">fromEvent</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">,</span> <span class=\"token string\">'keypress'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pluck</span><span class=\"token punctuation\">(</span><span class=\"token string\">'keyCode'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> keyCodesBuffer$ <span class=\"token operator\">=</span> keyCode$\n  <span class=\"token punctuation\">.</span><span class=\"token function\">buffer</span><span class=\"token punctuation\">(</span>keyCode$<span class=\"token punctuation\">.</span><span class=\"token function\">debounce</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MAX_INTERVAL_BETWEEN_EVENTS_IN_MS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isFromScan<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isFromScan</span><span class=\"token punctuation\">(</span>keyCodes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> keyCodes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> keyCodes<span class=\"token punctuation\">[</span>keyCodes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token constant\">ENTER_KEY_CODE</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">fillInputWith</span><span class=\"token punctuation\">(</span>keyCodes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// …</span>\n<span class=\"token punctuation\">}</span>\n\nkeyCodesBuffer$<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>fillInputWith<span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"what-we-did-here\"><a href=\"#what-we-did-here\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What we did here</h2>\n<p>This is a visual illustration of what we did to go from <code class=\"language-text\">keyCode$</code> − which was created from keypress events − to <code class=\"language-text\">keyCodesBuffer$</code> we subscribed to:</p>\n<figure>\n  <img src=\"/transforming-streams-4e3b123a0628dc94e7154641c8159656.gif\" alt=\"Transforming streams\">\n  <figcaption>Transforming the stream of key codes into a stream of scanned codes</figcaption>\n</figure>\n<p>There are a few things to notice with our final code:</p>\n<ul>\n<li>we don’t have to manage things like timeout and buffer manually</li>\n<li>hence, code is shorter, <strong>focused on the actual work</strong></li>\n<li><code class=\"language-text\">fillInputWith()</code> doesn’t rely on a global buffer, which is more <strong>testable</strong> and <strong>reusable</strong> − actually, we are few small steps from making the whole logic purely functional</li>\n<li>we just manipulate <em>const</em>s, nothing is reassigned, which is <strong>simpler to reason about</strong></li>\n<li>created Streams can be <strong>reused</strong> to do other things ; we can <strong>add features without fear</strong> of breaking this one</li>\n<li>we could easily fix issues in this code, injecting operators into streams creation pipes, if necessary − e.g. we’d probably filter out non-interesting key codes from <code class=\"language-text\">keyCode$</code> as simply as <code class=\"language-text\">.filter(isValidKeyCode)</code></li>\n</ul>\n<p>In my opinion, the one difficult thing is to reason with streams and understand how to solve our use case with given operators.</p>\n<p>But, I believe this is something that just takes practice 😉</p>","fields":{"tagSlugs":["/tags/observables/","/tags/rx-js/"]},"frontmatter":{"title":"Using observables in real life","tags":["observables","rx.js"],"date":"2017-03-23T00:00:00.000Z","description":"In this post, I’ll talk about a concrete use case in which Observables turn to be remarkably relevant to make our code cleaner and more maintainable."}}},"pageContext":{"slug":"/en/2017/03/using-observables-in-real-life/"}}