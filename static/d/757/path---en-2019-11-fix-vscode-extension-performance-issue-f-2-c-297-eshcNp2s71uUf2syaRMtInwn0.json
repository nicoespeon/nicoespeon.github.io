{"data":{"site":{"siteMetadata":{"title":"@nicoespeon's blog","subtitles":{"en":"I write about web development, agile practices and personal organization.","fr":"J‚Äô√©cris sur le d√©veloppement web, les pratiques agiles et l‚Äôorganisation personnelle."},"author":{"name":"Nicolas Carlo","twitter":"nicoespeon"},"url":"https://www.nicoespeon.com"}},"markdownRemark":{"id":"c8a7fc48-65f3-52ca-90c4-7ae52a00b287","html":"<p>I‚Äôm developing a VS Code Extension that provides intuitive automated refactorings in JavaScript and TypeScript. It‚Äôs called <a href=\"https://vscode-abracadabra.com/\">Abracadabra</a>.</p>\n<p>Recently, I looked for performance bottlenecks to make it faster. In this article, I‚Äôll explain how I did that, so you can do the same.</p>\n<h2 id=\"how-do-you-know-you-need-to-improve-performances\"><a href=\"#how-do-you-know-you-need-to-improve-performances\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How do you know you need to improve performances?</h2>\n<p>When I make things, I try to follow the mantra:</p>\n<blockquote>\n<p>‚ÄúMake it work, make it right, make it fast.‚Äù</p>\n<p>‚Äî Kent Beck</p>\n</blockquote>\n<p>Abracadabra is a side-project. I first developed the features I¬†needed and shipped that. As I learned along the way, I¬†kept refactoring the code to improve readability, thus maintainability. During this process, I took decisions I knew were a bit naive from a performance standpoint, but they simplify a lot the development. A few months after the first release, I had developed more than 20 automated refactorings. Today, it makes me much more productive when I code.</p>\n<p>Most refactorings are exposed as VS Code <a href=\"https://code.visualstudio.com/docs/editor/refactoring#_code-actions-quick-fixes-and-refactorings\">Quick Fixes</a>. Regarding where your cursor is, VS Code will tell you the relevant refactorings you can perform through the lightbulb üí°</p>\n<p>To determine what are the relevant refactorings, Abracadabra naively tries to perform each of them. Each refactoring that could change the code would be considered relevant. Any time the cursor changes position, VS Code would ask Abracadabra the same question: what are the relevant refactorings on this code, from the current selection? Hence, any time the cursor changes position, Abracadabra recomputes all refactorings of the catalog, again.</p>\n<p>That doesn‚Äôt sound very performant, does it?</p>\n<p>Indeed, <a href=\"https://github.com/nicoespeon/abracadabra/issues/18#issue-472611520\">I¬†thought about it at the beginning</a>, 2 weeks after the very first release. However, <strong>it wasn‚Äôt needed at that time</strong>. At that time, despite the theory, I couldn‚Äôt feel performance issues from usage. Thus, the naive implementation was fine. It kept the code simple, allowing me to develop more and understand the problem better.</p>\n<p>Improving performance implies writing less naive, harder to maintain code to make it fast enough for the users.</p>\n<blockquote>\n<p>Improving performance is a tradeoff on code maintainability.</p>\n</blockquote>\n<p>That‚Äôs why I think you shouldn‚Äôt improve performance without measuring it. <strong>Measure performance.</strong> That‚Äôs how you know if you need to improve it or if it‚Äôs good enough.</p>\n<h2 id=\"how-to-measure-the-performance-of-a-vs-code-extension\"><a href=\"#how-to-measure-the-performance-of-a-vs-code-extension\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to measure the performance of a VS Code Extension?</h2>\n<p>VS Code provides quite a good tooling to do so.</p>\n<h3 id=\"show-running-extensions\"><a href=\"#show-running-extensions\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Show Running Extensions</h3>\n<p>The first thing you need to do is to <a href=\"https://code.visualstudio.com/api/get-started/your-first-extension#debugging-the-extension\">debug your extension</a>. You certainly want to measure performance before and after your changes. Debugging your extension opens an extension host that will compile your extension code, so you can run it live.</p>\n<p>In the Extension Host, open the Palette (<code class=\"language-text\">‚åò ‚áß P</code> / <code class=\"language-text\">Ctrl Shift P</code>) and search for <strong>Show Running Extensions</strong>.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/show-running-extensions-8f7a0eb252f077560dd728ed263883a6-db395.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 14.309484193011649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAoElEQVQI133MUQvBUADF8b27G7aEsEvYbgwzY7MptiWU8v0/zd9VPCh5+HUezukYI3dI22nh1Go4wqQhrDeTplnHtv5pYJuWprdC0NU/xuF0IUwLZHLHS67E6VE7sctKgjDBn0eoYPPF/+SrW+Wo+IzaVKgwx1jsSzrpg97+QaCPo6zAX26RXoA7ndMfz+hPfhgrBn6IXFfI6IyMbwxmO56KwFW/vKf7QQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"show running extensions\"\n        title=\"\"\n        src=\"/static/show-running-extensions-8f7a0eb252f077560dd728ed263883a6-c83f1.png\"\n        srcset=\"/static/show-running-extensions-8f7a0eb252f077560dd728ed263883a6-569e3.png 240w,\n/static/show-running-extensions-8f7a0eb252f077560dd728ed263883a6-93400.png 480w,\n/static/show-running-extensions-8f7a0eb252f077560dd728ed263883a6-c83f1.png 960w,\n/static/show-running-extensions-8f7a0eb252f077560dd728ed263883a6-db395.png 1202w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>That will open a tab wich list your running extensions:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/running-extensions-33f5f2bc71e36d546afcaea79b002a17-02ac4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 46.45669291338583%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABTklEQVQoz32S2XKDMAxFee2SBGxjY3YISxM60742zfpTpH9/KxGaZKalD2ck7LlCurJj4hw2zlBULap2hWbVoaxbuMpABvEkfpgiSApYIi5qooKyCRzfphDaonp5Rdu9DVRth6JeQfgBZp7CXPiYeyOU8xnfpWWDOK+QUMEwLRBlFRdMhm5cqa8sBEdDBdQ0VPimMaTxh84dTa0rSpruHVFew/UtpIkgiKlx+S7MliiaDnm9Rt6skdFEbIHDc3MBTV6yLz/85x+j7MVHHWVXBg+FDuGpANmyRUl/Yu9K8lDS+cyVkyPzHTMshbq1SU4aSx2SUJLBihDkxz2e9O8Yv8UFwa9ghLVy1Dtz2vKzCeFnJR6VHjEj+hdPJHyg6NFTC+ipmWVzibTxRUgjfx1P6Jn9Hv32E+fjccjPB+J0usUhP6DffPzBhjQ79LstvgHiNfOKu9DeYgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"running extensions\"\n        title=\"\"\n        src=\"/static/running-extensions-33f5f2bc71e36d546afcaea79b002a17-c83f1.png\"\n        srcset=\"/static/running-extensions-33f5f2bc71e36d546afcaea79b002a17-569e3.png 240w,\n/static/running-extensions-33f5f2bc71e36d546afcaea79b002a17-93400.png 480w,\n/static/running-extensions-33f5f2bc71e36d546afcaea79b002a17-c83f1.png 960w,\n/static/running-extensions-33f5f2bc71e36d546afcaea79b002a17-02ac4.png 1270w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>The first thing you can see from this tab is the <em>Startup Activation</em> time. It tells you the time each extension took to activate.</p>\n<p>As a rule of thumb, if your extension takes more than 500ms to activate, there‚Äôs probably something you could do to speed that up‚Äîit‚Äôd be a good idea to <a href=\"https://code.visualstudio.com/api/working-with-extensions/bundling-extension\">bundle your extension</a> if you don‚Äôt do that already.</p>\n<p>If you‚Äôre below that, I‚Äôd say that‚Äôs OK. Around 100-200ms is great. Below is amazing üòâüëç</p>\n<p>Now, that was for startup activation time. But if you‚Äôre probably concerned with your extension <em>runtime</em> performance. So how can we track that?</p>\n<h3 id=\"record-extension-profile\"><a href=\"#record-extension-profile\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Record Extension profile</h3>\n<p>On the top right, you have a series of icons that will allow you to record a performance profile of the extension at runtime.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/running-extensions-icons-3db68c794980c76ea1af041b0191879e-41965.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 326px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 20.858895705521473%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAtUlEQVQY001Q2Q6CMBDkCzw4C7RgPRARgWCCZyT6aGLi///MymxS4sOmuzOd2WktR0iyg5hwotxQ0cwLGUMPbOoKxswcyAV5UTJq/rUWmu2+pvWuZGDuR5QfGlJ6wz2E9fFEWVGxaZSuqO0uA9aNPBb4ccqmFoC8bFiAfuIIuvUvKqqWk+Hy+/Ol870fuIDUMmP++ngyL5QmqTNexIZIFSaahSY2jO1Ajk80X4IZBROTyPDmi35iEWuV+clEtwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"running extensions icons\"\n        title=\"\"\n        src=\"/static/running-extensions-icons-3db68c794980c76ea1af041b0191879e-41965.png\"\n        srcset=\"/static/running-extensions-icons-3db68c794980c76ea1af041b0191879e-f1b80.png 240w,\n/static/running-extensions-icons-3db68c794980c76ea1af041b0191879e-41965.png 326w\"\n        sizes=\"(max-width: 326px) 100vw, 326px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Click on the record button (the dot in the circle). It will turn red, meaning it‚Äôs recording.</p>\n<p>Then, go back to your code. Trigger your extension. In the case of Abracadabra, I was suspecting performance issues on Quick Fixes, so I moved my cursor around the code, to trigger Quick Fixes.</p>\n<p>When you‚Äôre done, go back to the <strong>Running Extension</strong> tab and stop the recording. Then, click on the most-left icon to download the <code class=\"language-text\">.cpuprofile</code> you just recorded.</p>\n<p>This CPU profile can be loaded in some DevTools. You can use the DevTools available in VS Code! Open the Palette again, and search for <strong>Toggle Developer Tools</strong>.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/toggle-devtools-ef334f5651b471517fc094a67de59ac9-bb136.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 14.572864321608039%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAq0lEQVQI123Kyw7BQACF4a6ZtkosSNUlQnW0JaWmoxlEkLDy/g/zmyBWFt/iXJxRGNHxA7yGwG+6lqBlBcIlcD3L/6slvM8uxFvbijpdHH15ouoz2tyozJW9uZDXD5bVFbmqSHJFkpU/CytdVyh9pNgZ5O5Gou5I9Xj/nbg8Idcly0KTbWvSjUZuahKbw5UhinN6wyn98Yz+6Gs8ZzCZMYgLwtRYB8LsZPuYF9+mVlp1mOl+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"toggle devtools\"\n        title=\"\"\n        src=\"/static/toggle-devtools-ef334f5651b471517fc094a67de59ac9-c83f1.png\"\n        srcset=\"/static/toggle-devtools-ef334f5651b471517fc094a67de59ac9-569e3.png 240w,\n/static/toggle-devtools-ef334f5651b471517fc094a67de59ac9-93400.png 480w,\n/static/toggle-devtools-ef334f5651b471517fc094a67de59ac9-c83f1.png 960w,\n/static/toggle-devtools-ef334f5651b471517fc094a67de59ac9-bb136.png 1194w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>If you‚Äôre familiar with Chrome DevTools, well, it‚Äôs the same. Open the <strong>JavaScript Profiler</strong> tab. This one is hidden:¬†you need to reach for the 3 dots menu ‚Üí More tools ‚Üí JavaScript Profiler.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/javascript-profiler-4471a5826d07181f434e2e3643c4e52a-518f5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 53.45454545454545%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB3ElEQVQoz4WTW08TURSF+2f9G76jEp9JfFIkPvho1EJCCAZIfKlYKr3MrXPp3O+XFmnn88xQtQiNO1lZZ59k1l77ZE3HNE10XScMQ2RZpul930dRlJYNw2jvTDugN5DoD2Uc1yOKI/I0JVQkIk8lSVLiyKejqiqO42BZFkEQtCJRFP05e55PlmWkWU4QpShmyMy2kWQFW7AhhjXDNSF8KQd0lsslq9WKhn+fN/vNu1ogE65sYaARMoWJZgPDaLbysBwhyH+qrus17vqiKJjIKv3BNVNduNN0NMFhFLdDOn8/uI9tNa8KXEtDmVwz02XKxIXbnJvcJ3a1+w43xeaLhXj4BD8IWy7Kivm8QjJjDk5nvD2e8u7MZ/8s4815zuvzir3j6KEga9GyyJiqE66+f8OzTao8ZjWPGWkee0ce+19CXp3EvDzM2e0W7Hwu2elW2xzW6G7GSU/nw+mAr0Of/jTnYpwz0GI8S2U8vCIJZnCTtoPqRcyyCh8KrtYrf+ylPH3vs/sp5sXhgmdHP3lycMvzbo4qj+n/GBGEUQs/aDgW+fQfWZk7l1WZiWxNUKQRnmMyMzTKLCQV4XVct81q8zP8i87jEanbMI8mEr3LfhuRhhVtSiJy2GRyW/0C9xQ7HP+6pUUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"javascript profiler\"\n        title=\"\"\n        src=\"/static/javascript-profiler-4471a5826d07181f434e2e3643c4e52a-c83f1.png\"\n        srcset=\"/static/javascript-profiler-4471a5826d07181f434e2e3643c4e52a-569e3.png 240w,\n/static/javascript-profiler-4471a5826d07181f434e2e3643c4e52a-93400.png 480w,\n/static/javascript-profiler-4471a5826d07181f434e2e3643c4e52a-c83f1.png 960w,\n/static/javascript-profiler-4471a5826d07181f434e2e3643c4e52a-518f5.png 1100w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>From there, you can start profiling JS‚Äîbut we already did that using VS Code Running Extension. You also have a <strong>Load</strong> button you can use to load your <code class=\"language-text\">.cpuprofile</code>.</p>\n<blockquote>\n<p>Note: on Mac OS, if your finder doesn‚Äôt show all file extensions, it might save the file as <code class=\"language-text\">.cpuprofile.txt</code> and you won‚Äôt notice. If you can‚Äôt load that in DevTools, you need to use the terminal to rename it with the proper extension, by removing the <code class=\"language-text\">.txt</code> part.</p>\n</blockquote>\n<h3 id=\"analyze-the-profile\"><a href=\"#analyze-the-profile\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Analyze the profile</h3>\n<p>I prefer to use the Flame Chart, it‚Äôs much more visual.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/flame-chart-a2a10140a5d2011060ca1e0616b3b661-d50df.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 29.9860529986053%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABRUlEQVQY0z2Qy0rDUBCG88Ru3fgELlxUFAUREXEhIiI+gFshQgMSStqm5H47SXNtQtPkd+YEO/AzA2fmO/+M4jgOgiCAZdmI45hqH7NXFWcPKk7vf3By/Y23Lx1J5NNbKHtYYRjCdV0EkcBiZcFY29jYARTLnkDb7RZ1XaMsSzw9v2B2dYubu0ecX1zi/eMTnu8jihiWEMiTvU3ToChKlFUtVZQVFNvxsLEcxEkioaxUCJimCY8ciDia3Hg+8jyHECmM5RpJIgjaYDgc0Pc9DiyqFcP4haqqmM816LoOTdOQZRmaXSt/7boObdshLwrKrcyeH8Bxfeyoh2PEFOxaSVNBgPTojmEMEWk2uagq1LRaEEbyHLzJcm1SFhNsHKU4BG2mMJVV0SCLh/r9Xg6wqqrEjpwxsCB3fMOFsZInGIbhCP0H/gGy8byzxJP9jwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"flame chart\"\n        title=\"\"\n        src=\"/static/flame-chart-a2a10140a5d2011060ca1e0616b3b661-c83f1.png\"\n        srcset=\"/static/flame-chart-a2a10140a5d2011060ca1e0616b3b661-569e3.png 240w,\n/static/flame-chart-a2a10140a5d2011060ca1e0616b3b661-93400.png 480w,\n/static/flame-chart-a2a10140a5d2011060ca1e0616b3b661-c83f1.png 960w,\n/static/flame-chart-a2a10140a5d2011060ca1e0616b3b661-d50df.png 1434w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/flame-chart-2-04285138b2cdd14bbd50ec39d0f0ab5c-71b64.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 70.51162790697674%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACwElEQVQ4y11SaXPaQAzl//+QfumVhPuGgIFwQwg2PtcXYAzGQIDQtLzKdptk4hnNWz1JTyuvYrZtwTQNWJYBXdchyVroG4b+CRkM04LGotyoxgzj7zkGYoxZUBQT8/maCAcqcynoRP4nZPoKlr2FaSyhqiYYm2Ox2LzlM8YQK2d5ZG9EtCse2uUNOlUPD4TtyuYfeh9wHcabxSUS30aoZkx07rfkrzFqbXE8nhGbNCTwdRq3twHrrt8s8D9z/3m5vUC/yENtO6GvdVxYEw/XP6CRqwx2zsa+sceO24Xmcz7sgg234mLPvfOBBXke50FOyVhX16Hv13wc+gdcf18RU+8ZrMIcXmNHiX6Ibt2DlFFglxYR98E23BZ2ZQE5q8K5X8NvUoO6D3+wpxuSoE7jzktLEnov2pKolmdYVBzsWodQZENNAt6t0a8o0YPk9TDOCgYcmmQ3OESCYllC68sD1lSg5hiGP8Ywizae4jz634eYJSUoGQ0ijRicpbQCKStjcjfFlHJGPx8xoAdSKhpwDf5hnWF6y9P1HYhJEXxcgJbTqFAmERFCQqBGGokqECgmE7ICI06FklXAJ3jMEjPoNR3BF5txKoa3U4iUNE4KeMpQ97SEISU+pmbkS5hSYcAP6FZBTChomBA/Ts/QvXnEOCFCbZiRINfV8SOlIF02Ec9rSFByPK/ilsZKUJM7ukmyqIfnr/EpUiUdhZqBdEmjs0pxieIMXHcRCY4FF82uAc08YSp6ZLRn7BkzxQ9R0g6EB0h0FiRa/PGWin3UOh7qnS1yVQtFboXh9BAJWosjZEWhF7rQptNO+Ru8vp7x63IK7fLBcH0Bs84kekJ3ckJvcka5uSJhH7xyQfAqMd064qGnYDjRIchLMGMLx33BfHnE3Dli6Z4jW52Je4aoHTHiA7Ej+k8nVFsrcL0dZupLKPgXCHfmWw/fDKwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"flame chart 2\"\n        title=\"\"\n        src=\"/static/flame-chart-2-04285138b2cdd14bbd50ec39d0f0ab5c-c83f1.png\"\n        srcset=\"/static/flame-chart-2-04285138b2cdd14bbd50ec39d0f0ab5c-569e3.png 240w,\n/static/flame-chart-2-04285138b2cdd14bbd50ec39d0f0ab5c-93400.png 480w,\n/static/flame-chart-2-04285138b2cdd14bbd50ec39d0f0ab5c-c83f1.png 960w,\n/static/flame-chart-2-04285138b2cdd14bbd50ec39d0f0ab5c-23e13.png 1440w,\n/static/flame-chart-2-04285138b2cdd14bbd50ec39d0f0ab5c-10d8f.png 1920w,\n/static/flame-chart-2-04285138b2cdd14bbd50ec39d0f0ab5c-71b64.png 2150w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>I‚Äôll suppose you know <a href=\"https://developer.mozilla.org/en-US/docs/Tools/Performance/Flame_Chart\">how to interpret Flame Charts</a>.</p>\n<p>From this specific one, we can see 2 things:</p>\n<ol>\n<li>The extension <code class=\"language-text\">parse()</code> the code repeatedly, which adds up and takes a lot of time in the end.</li>\n<li>It runs one <code class=\"language-text\">provideCodeActions()</code> per refactoring, which could also be optimized.</li>\n</ol>\n<p>That‚Äôs even clearer if we zoom in a bit:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/flame-chart-2-zoomed-in-546da4efc8ba0afe5f9f5884671d469a-9aef4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 25.119846596356666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAABE0lEQVQY04WN3VKCYBRFef8nqalpQq00QkvBxDE1RS1KSNAyLUEsfnLG1adXedXFmj17n3P2kbSsSevSxjHCf7FrIeNWRE/30GQTS5vzfOuLfClY4bZXSAfyPbLiohpfqCJUxdFOjdWeFsW8oPvcNITXXQ6zPRR9zlX1k1J9KXZ8jM43klIe0ej6DIYRze6Mu847lpMKEiw7+aMpfSukZX5Qrr1SrC6otSMK12PO1RE5xUGrz5C0ms3Qttls1vykMWEYkApNkmiPOI5YrxOCZUTF8DjODXYFmYLF6cUjJ2cD8Wi6LXyh2X7A7D8xdCZMZwF+ELPwIxbBH4TflnkTH73ucZQxRcGYfMlBqbwh5y2KmssvbpZjKhvHz8IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Flame chart before optimization, it's wide and has a lot of operations\"\n        title=\"\"\n        src=\"/static/flame-chart-2-zoomed-in-546da4efc8ba0afe5f9f5884671d469a-c83f1.png\"\n        srcset=\"/static/flame-chart-2-zoomed-in-546da4efc8ba0afe5f9f5884671d469a-569e3.png 240w,\n/static/flame-chart-2-zoomed-in-546da4efc8ba0afe5f9f5884671d469a-93400.png 480w,\n/static/flame-chart-2-zoomed-in-546da4efc8ba0afe5f9f5884671d469a-c83f1.png 960w,\n/static/flame-chart-2-zoomed-in-546da4efc8ba0afe5f9f5884671d469a-23e13.png 1440w,\n/static/flame-chart-2-zoomed-in-546da4efc8ba0afe5f9f5884671d469a-10d8f.png 1920w,\n/static/flame-chart-2-zoomed-in-546da4efc8ba0afe5f9f5884671d469a-9aef4.png 2086w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>So I went back to the code and optimized for that.</p>\n<p>I parsed the code only once, then gave the AST to all refactorings. Then, I collected the list of available refactorings and provided them to VS Code only once. Here‚Äôs the same profiling, after the changes:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/flame-chart-after-optimization-0823b0473fd68eaefd9560c5a201d677-29c8d.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 91.63722025912838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACo0lEQVQ4y6VUaVfaQBTl//+KfuiXarWtYj2loiwJiCKGQCDBo0kgG0vIVkHW28cEKljb04Vz7rnvzh3uvMlkkuh0OlBVDe12zLreXus2NI1YX7HOxja+TlrXY2ispjnkGYaBhGWb6PZsOF2LoWMZsBwTNtUxNjXN6TnMc3bGY7D/UnMJSVSRS9dRq1iQxQHkmotmtQ+lPkST9AoKG9vyiNnctbfiluRC1SwkykUVe2/KuEgaKKRc8IRCarjm3Xrbe/ap/uLiMj3E6HGBRFux0Czcw6wPYNT6MMTeM7+sxf7P3lqb0gCzpzkStmCjeSDDzboIuBB+PthB8EK/6uWoLoSYj6hDS7QhH7Vg57rwigGGBf/vwfvwSkEcaFfp5M4ceIWAGf8EjgIv14GmYKF2KMG4sH506G2tzhba0a942x36dz7K7yoQPojoZvvw+OD/OhybTxAORNweVmGc27Tii8DCb4LWnstvB9pjCHu3aCUV+JyHkCaFtHXGfwoKDGnLi1Vg5I2RPaqDP1HQyNObT8ffyA8h5T00+ZB0hAYXoLkBH3NjU/NxrVyGmKwCvfEYxxkV6VKETDlE9spA/kpBS38kjFCjZ6xaUzyYv8KEsWpNMJlS4Gg2Q5rTkMo6ECTqSunAog8E+y3n6Pd7mM+mhAlm0wnjjWaYT2NNvFxS4JxSM7yGvU8ihHoXkmxAVlq4u1dhOz1o9Fkbej6CMIIfhAgIHmnPpxuyhSj6hsWCAhfTJXLFNt4fS7itOdStjmRKwul5C8WbAaqNCBW6r1zJQEWKUBY9XHAPqNRD5EsmimUT10KPtIvZfInEamc3dOn36WDkuyEFaUietXGUekCGXoXr2gSZoo1DOrQMPeczro+3+zf4fG6yOR9PZXzNWTSnR4HAd8s7FeBtU+zbAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Flame chart after optimization, it's narrow and shows less operations\"\n        title=\"\"\n        src=\"/static/flame-chart-after-optimization-0823b0473fd68eaefd9560c5a201d677-c83f1.png\"\n        srcset=\"/static/flame-chart-after-optimization-0823b0473fd68eaefd9560c5a201d677-569e3.png 240w,\n/static/flame-chart-after-optimization-0823b0473fd68eaefd9560c5a201d677-93400.png 480w,\n/static/flame-chart-after-optimization-0823b0473fd68eaefd9560c5a201d677-c83f1.png 960w,\n/static/flame-chart-after-optimization-0823b0473fd68eaefd9560c5a201d677-23e13.png 1440w,\n/static/flame-chart-after-optimization-0823b0473fd68eaefd9560c5a201d677-29c8d.png 1698w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Much. Better. üòòüëå</p>\n<h3 id=\"anecdote-optimizing-for-performance-makes-code-less-intuitive\"><a href=\"#anecdote-optimizing-for-performance-makes-code-less-intuitive\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Anecdote: optimizing for performance makes code less intuitive</h3>\n<p>As you can see, profiling Abracadabra made me confident the problem was essentially due to every individual refactoring reparsing the same code. This was naive and I optimized so the code is now only parsed once.</p>\n<p>But when I¬†did so, I created issues that didn‚Äôt exist before! I had to tackle them.</p>\n<p>Indeed, all refactorings now share the reference to the same AST. If one refactoring were to modify that reference, that would cause problems to the others. Cloning the AST¬†could sound like a solution. I actually tried that and measure the performances after. It was worse. In fact, cloning the AST between each refactoring was <strong>more expensive</strong> than parsing the code each time.</p>\n<p>That‚Äôs the heart of performance optimization: don‚Äôt guess, measure. Sometimes you‚Äôll guess right. Sometimes, you won‚Äôt.</p>\n<p>The actual fix was to ensure each refactoring wouldn‚Äôt mutate the AST when running for Quick Fixes. I had to introduce a bit more complexity in the code to optimize it. That‚Äôs usually the case when you optimize for performances. That‚Äôs why I follow Kent Beck‚Äôs mantra. If the code is simple enough, it‚Äôs easy to tweak it where necessary, for performance reasons.</p>\n<p>Oh and a useful tip: when you¬†do that, leave a comment to explain why this part of the code is not simpler. Your future-self and colleagues will thank you.</p>\n<h2 id=\"conclusion\"><a href=\"#conclusion\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>If you‚Äôre developing a VS Code Extension, I hope this guide would have helped you to find and fix performance issues.</p>\n<p>If you have a problem with your VS Code performances in general, I suggest you read <a href=\"https://github.com/microsoft/vscode-wiki/blob/master/Performance-Issues.md\">their wiki page on performance issues</a>,</p>\n<p>If you‚Äôre using VS Code to code in JavaScript or TypeScript, I can only recommend you give a try to <a href=\"http://bit.ly/vscode-abracadabra\">Abracadabra</a>. I craft these automated refactorings so they are useful and quick to use. It should save you a lot of time every day. It does for me üôÇ</p>\n<p>Finally, I wish I made you think twice about handling performance issues. Make it work, make it right, make it fast. What do you think?</p>","fields":{"tagSlugs":["/tags/vscode/","/tags/performance/","/tags/side-project/"],"slug":"/en/2019/11/fix-vscode-extension-performance-issue/"},"timeToRead":7,"frontmatter":{"title":"Find and fix performance issues of your VS Code Extension","tags":["vscode","performance","side-project"],"date":"2019-11-26T00:00:00.000Z","description":"I fixed a performance issue on a VS Code Extension I'm developing. Let me share with you what I¬†learned."}}},"pageContext":{"slug":"/en/2019/11/fix-vscode-extension-performance-issue/"}}