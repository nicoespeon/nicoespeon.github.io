{"data":{"site":{"siteMetadata":{"title":"@nicoespeon's blog","subtitles":{"en":"I write about web development, agile practices and personal organization.","fr":"J’écris sur le développement web, les pratiques agiles et l’organisation personnelle."},"author":{"name":"Nicolas Carlo","twitter":"nicoespeon"},"disqusShortname":"nicoespeon","url":"https://www.nicoespeon.com"}},"markdownRemark":{"id":"6feb171b-9600-5e10-a447-fe389cd7490d","html":"<h2 id=\"the-context\"><a href=\"#the-context\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The context</h2>\n<p>The life of a git repo could last and change a lot. Conventions often move with our knowledge and mastering of that stuff.</p>\n<p>And there comes the day where you look at your project and realize that it wasn’t such a good idea to commit those <em>external libraries / compiled outputs / videos and other media / &#x3C;your error here></em>.</p>\n<p>I personally did a bunch of mistakes with git:</p>\n<ul>\n<li>one day I realized a bit late that if you commit a lot of audio files in your project, then you’ll make it grow insanely. 5 minutes to perform a simple <code class=\"language-text\">git clone</code> is waaaaaay toooo looooooong.</li>\n<li>few time ago, I even managed to commit the whole <code class=\"language-text\">vendor/</code> folder of a project by mistake. It didn’t play well with the nice GitHub stats of the project. That’s a tough job to follow the activity of the team when there is a 20.000 updates peak on the very first week.</li>\n</ul>\n<p>And then you realize that:</p>\n<ul>\n<li>it’s pointless to revert the faulty commit(s), it won’t remove the indexed modifications from the history</li>\n<li>the project may not be young, it’d be sad to rebase and re-write every commits from the last 3 months and loose information such as the author / the date</li>\n<li>and even sometimes you’ll have your faulty files committed with other fixes and killer-features</li>\n</ul>\n<p>Need another use case? Just think about Bernard who committed confidential information in a environment config file which should never have been versioned -have you heard about a guy called Murphy?.</p>\n<p>Now you can figure out that situation when you open the Internet, searching for the magic git command. Here you go, this is precisely what’s this post about -at least, the magic command I know.</p>\n<h2 id=\"magic-happens-here\"><a href=\"#magic-happens-here\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Magic happens here</h2>\n<p>Let’s say I would like to <strong>remove every MP3 files committed by mistake</strong> from a whole project. Plus, <strong>I don’t want to change the author of each commit, neither the date</strong> - but still I want to remove all trace from those files in the history to reduce the size of my repo.</p>\n<p>To do so, I mystically wave my hand in the air and write the following incantation with the other:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git filter-branch -f --tree-filter &quot;rm -rf \\*.mp3&quot; --prune-empty -- --all</code></pre></div>\n<p>Which would transform this history:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dirty-repo-9bc37cbec88d16d9268d1ef41cee0eca-f7e1d.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 86.06965174129354%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACfUlEQVQ4y2VUXU/UQBTt/3/20V9gfFACApKQgEGJuyCaiLsua8AXcD/bbmem03bmeD/a3aJNTu7HTG/PnXumyWA4w2rlwI+xQGEIBZBvAOc0tlbRX2c/NFHei2rkSY7ffMCfx4UEddmgthVqVwuacmc7dOuNb9pCkWzcFk3GL18ge/ilUUG0llQ8TxWbDEjXZHMgozgjf7Wk3Irom5Zd3FJkP9nfG2I+yyRRlhGuhIBbstRy6Z/Dec3zcXi/azW2RZPzszFubm6FelVFKhqkcAfOebLeK/5di72WhaGldg4/7mEw+aSDaTYoo4GLBYFsMPDRwYZC8mW0kjchF7hgO45acLVY4+rHZ1yPB5J2tUUVPHwot+C4g29KlI0TP0QeTJAzjC2S9TLF5egSV9OhzoWYEAdi4UCvwjIjspQR3wi4gxJxy60nmwW1PNk/xMPRiWbmNMUVT5QmnhdqGWmuMdusFeo6RVzQfkJMM8QmIFlmOUbnZ5heXEi9wAukXgGpOdK4//M3hVoec10jVpVYbj1Z5EvcvT/G79NT1dNirrpLWYebnQbl+mTqr1diuVBsW+6QvH51jen9HKaiA6cPFe0VM041J3osVXemvYq8x/U02H+Syc9HfB/d4u5+LAnraRT0ZV9XKGtPvldbtzmO2/UqdPCoY61TdkWGk8EBhtNL1WHIRIOsORs3W3DOiwY7PapWec0E0i7pMZCEkr23X/Dt60TZmYiCjszQcTnbglr0fAXJLx3vUctr7Bs6Zkv7q/YIkncHV5jNUgnkmvkduphtH/1cTb+whhCCjiU5Ohzh6Ul/Ds5FGGJpbZSvc6w59W3LSv6Hhgk8HwiL5C+RuiU02PAD0AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Dirty git repository\"\n        title=\"\"\n        src=\"/static/dirty-repo-9bc37cbec88d16d9268d1ef41cee0eca-c83f1.png\"\n        srcset=\"/static/dirty-repo-9bc37cbec88d16d9268d1ef41cee0eca-569e3.png 240w,\n/static/dirty-repo-9bc37cbec88d16d9268d1ef41cee0eca-93400.png 480w,\n/static/dirty-repo-9bc37cbec88d16d9268d1ef41cee0eca-c83f1.png 960w,\n/static/dirty-repo-9bc37cbec88d16d9268d1ef41cee0eca-f7e1d.png 1206w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Into this clean and shiny one:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/clean-repo-01ac1cdb9ead771b8a6e8c336e5f821b-c2c2d.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 69.04376012965965%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB7UlEQVQ4y21U227TQBD1//8JvMEDRPQFJIQSpWpLoQ2NWqEAIiENaRLvzd71DHPZtdMWSycznt2dnDM74+p0usL7e4P8eAdoDaChV0bwiNZyXMG+c/hoHUCO9rYavT3D5XIrL00D6D1gCIPl2LEt4HWOpcSZQBIC/VSvX33G2/lSEjpi6JgFwRq1zILZFduzzeuxLQyVYrVZ/8XRxzc4X81UdmewAYcBrID9Fjz5LscHeDC032LbNX3Sarfd4+lsgpOrT8oyUpIuHKGhA23vMwL5Ci/JEqQh4cPmAaffxji9GUvQxFo2+s5lS0yz78jnuE01umSIedZ79FSH3QGn12OcXCtDG40cLmwK09Bb/98YI9IfVD8Xv/Dy7gKvFpcqOWVGVLcmQ5KQbSHkWoYcd8KYz5RaVi9fnOHibou+pgDV1tV0MXyD3GdusN6qz2vmQEpoXxvwueTt5oAX83ORLQxbYpeajICeEAQkP7VHawq9JC1DhIjV6vcST8YjvF3fSINywbVlnMhwnbYGg2XKJZW2yXHX1bKvhYYb+wvOvv5QdhZECqPI9Lm5C0qzOzs0eL3XcqRIkk/eneOf9e7Z6D0dt6ejx1PFNkbAjvqv60D78MP77zTLe01YNvKYMaOgKL7PLH35aJBN6fGl/AOJVz3TV6aILwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Clean git repository\"\n        title=\"\"\n        src=\"/static/clean-repo-01ac1cdb9ead771b8a6e8c336e5f821b-c83f1.png\"\n        srcset=\"/static/clean-repo-01ac1cdb9ead771b8a6e8c336e5f821b-569e3.png 240w,\n/static/clean-repo-01ac1cdb9ead771b8a6e8c336e5f821b-93400.png 480w,\n/static/clean-repo-01ac1cdb9ead771b8a6e8c336e5f821b-c83f1.png 960w,\n/static/clean-repo-01ac1cdb9ead771b8a6e8c336e5f821b-c2c2d.png 1234w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Dates and authors are still there, which wouldn’t have been true with a classic rebase. Still, the history <strong>has been rewritten</strong>: SHA1 of commits which have been rewritten are different.</p>\n<h2 id=\"its-a-kind-of-magic\"><a href=\"#its-a-kind-of-magic\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>It’s a kind of magic</h2>\n<p>Let’s see what is this looooong mystical command about.</p>\n<h3 id=\"git-filter-branch\"><a href=\"#git-filter-branch\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">git filter-branch</code></h3>\n<p>The <code class=\"language-text\">filter-branch</code> command will rewrite a large number of commit in a scriptable way. In other words, it will rewrite the history regarding the options you give.</p>\n<h3 id=\"-f\"><a href=\"#-f\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">-f</code></h3>\n<p>The <code class=\"language-text\">-f</code> option forces <code class=\"language-text\">git filter-branch</code> to start even if there is an existing temporary <code class=\"language-text\">refs/original/</code> directory already. Git will use this directory to perform some backup before going further.</p>\n<p>It’s not mandatory then, but if the backup can’t be created, git will tell you to use it anyway.</p>\n<h3 id=\"--tree-filter-shell-command\"><a href=\"#--tree-filter-shell-command\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">--tree-filter &quot;&lt;shell command&gt;&quot;</code></h3>\n<p>This option will check every commit of your tree and execute the given shell command.</p>\n<p>I previously used <code class=\"language-text\">rm -rf *.mp3</code> to ensure there will not be any MP3 file surviving this operation. In this case, I needed to ensure the command is forced -this is for the <code class=\"language-text\">-rf</code> part- so the cleaning won’t stop if there is an error because of <em>no-mp3-file-in-this-commit</em> reason.</p>\n<p><strong>Note</strong> - In case you don’t want to actually delete these files but just remove them from the git history, prefer to perform a <code>—index-filter “git rm -rf —cached —ignore-unmatch *.mp3”</code> instead.</p>\n<h3 id=\"--prune-empty\"><a href=\"#--prune-empty\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">--prune-empty</code></h3>\n<p>We prune any commit that would eventually be empty after we cleaned the history.</p>\n<h3 id=\"-----all\"><a href=\"#-----all\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">-- --all</code></h3>\n<p>The first <code class=\"language-text\">--</code> will ensure we don’t consider <code class=\"language-text\">--all</code> as a parameter for <code class=\"language-text\">--prune-empty</code>, but as another option. And so git will consider every branches of the history to perform the cleaning here.</p>\n<h2 id=\"final-words\"><a href=\"#final-words\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Final words</h2>\n<p>If you’re many to work on the project, please remember that <strong>rewrite the history is not a genuine action</strong>, whatever the method you use. Then, if you really need to do that kind of manipulation, it will be easier for you colleagues to simply clone the new shiny repo.</p>\n<p>If you fear that your manipulation won’t work as expected, just clone the repo somewhere else before doing your stuff. So you’d be able to get it back in case something is going wrong.</p>\n<p><strong>Note</strong> - A good idea is to perform that kind of operations in another branch. If you’re satisfied with the result, just reset hard the <code class=\"language-text\">master</code> branch onto this one and you’re all set.</p>\n<p>Here you go. I hope that could help you… but that you won’t need to use it too often!</p>","fields":{"tagSlugs":["/tags/git/"]},"timeToRead":4,"frontmatter":{"title":"Clean your git repo, like a boss","tags":["git"],"date":"2014-04-23T00:00:00.000Z","description":"How to properly rebase your repo, removing what should never have been in there without broking your history."}}},"pageContext":{"slug":"/en/2014/04/clean-git-repo-like-a-boss/"}}